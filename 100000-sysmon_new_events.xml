<!--
  Wazuh Rules for New Sysmon Events (Events 16+)

  This file extends Wazuh's base Sysmon ruleset (0595-win-sysmon_rules.xml)
  by adding support for newer Sysmon events introduced in recent versions.

  Dependencies:
  - Requires Wazuh base rules: 61600 (Sysmon informational event)
  - Requires rule 63103 for Windows Security log clearing detection
  - Requires rule 60106 for Pass-the-Hash detection

  References:
  - SOCFortress: https://github.com/socfortress/Wazuh-Rules/tree/main/Sysmon%20New%20Events
  - Wazuh Sysmon Rules: https://github.com/wazuh/wazuh-ruleset/blob/master/rules/0595-win-sysmon_rules.xml
-->

<group name="windows,sysmon,">

  <!-- Sysmon Event 17: Named Pipe Created -->
  <rule id="61646" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^17$</field>
    <description>Sysmon - Event 17: PipeEvent (Pipe Created)</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_17,</group>
  </rule>

  <!-- Sysmon Event 18: Named Pipe Connected -->
  <rule id="61647" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^18$</field>
    <description>Sysmon - Event 18: PipeEvent (Pipe Connected)</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_18,</group>
  </rule>

  <!-- Sysmon Event 22: DNS Query -->
  <rule id="61644" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^22$</field>
    <description>Sysmon - Event 22: DNS Request</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_22,</group>
    <mitre>
      <id>T1071</id>
    </mitre>
  </rule>

  <!-- Sysmon Event 19: WMI Event Filter Activity -->
  <rule id="100203" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^19$</field>
    <description>Sysmon - Event 19: WmiEvent (WmiEventFilter activity detected)</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_19,</group>
    <mitre>
      <id>T1047</id>
    </mitre>
  </rule>

  <!-- Sysmon Event 20: WMI Event Consumer Activity -->
  <rule id="100204" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^20$</field>
    <description>Sysmon - Event 20: WmiEvent (WmiEventConsumer activity detected)</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_20,</group>
    <mitre>
      <id>T1047</id>
    </mitre>
  </rule>

  <!-- Sysmon Event 21: WMI Event Consumer to Filter Binding -->
  <rule id="100205" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^21$</field>
    <description>Sysmon - Event 21: WmiEvent (WmiEventConsumerToFilter activity detected)</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_21,</group>
    <mitre>
      <id>T1047</id>
    </mitre>
  </rule>

  <!-- Sysmon Event 23: File Delete -->
  <rule id="100206" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^23$</field>
    <description>Sysmon - Event 23: FileDelete (A file delete was detected)</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_23,</group>
    <mitre>
      <id>T1107</id>
      <id>T1485</id>
    </mitre>
  </rule>

  <!-- Sysmon Event 24: Clipboard Change -->
  <rule id="100207" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^24$</field>
    <description>Sysmon - Event 24: ClipboardChange (New content in the clipboard)</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_24,</group>
    <mitre>
      <id>T1115</id>
    </mitre>
  </rule>

  <!-- Sysmon Event 25: Process Tampering -->
  <rule id="100208" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^25$</field>
    <description>Sysmon - Event 25: ProcessTampering (Process image change)</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_25,</group>
    <mitre>
      <id>T1055</id>
    </mitre>
  </rule>

  <!-- Windows Security Log Cleared Detection -->
  <rule id="100209" level="12">
    <if_sid>63103</if_sid>
    <field name="win.system.channel">^Security$</field>
    <description>Sysmon: Windows Security log was cleared</description>
    <mitre>
      <id>T1070</id>
      <id>T1107</id>
    </mitre>
    <group>sysmon,</group>
  </rule>

  <!-- Pass-the-Hash Detection -->
  <rule id="100210" level="12">
    <if_sid>60106</if_sid>
    <field name="win.eventdata.logonProcessName">^NtLmSsp$</field>
    <field name="win.eventdata.keyLength">^0$</field>
    <description>Sysmon: Potential User Login Via Pass the Hash Detected</description>
    <mitre>
      <id>T1078</id>
    </mitre>
    <group>sysmon,</group>
  </rule>

  <!-- Sysmon Event 6: Driver Loaded (Enhanced Version) -->
  <rule id="100211" level="3">
    <if_sid>61600</if_sid>
    <field name="win.system.eventID">^6$</field>
    <description>Sysmon - Event 6: Driver Loaded</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_event_06,</group>
  </rule>

</group>
