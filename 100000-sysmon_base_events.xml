<!--
  Wazuh Base Rules for Sysmon Events

  This file provides parent rules for Windows Sysmon events that serve as
  dependencies for Sigma-converted rules. These base rules detect fundamental
  Sysmon event types and provide the foundation for more specific detections.

  Rule ID Ranges:
  - 61600-61649: Base Sysmon parent rules (Events 1-26)
  - 100200-100299: Extended Sysmon event detection rules

  Dependencies:
  - These rules depend on Wazuh's base Windows event decoder (18100)
  - Sigma-converted rules use if_sid to depend on these parent rules

  References:
  - Sysmon Documentation: https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon
  - Wazuh Sysmon Integration: https://documentation.wazuh.com/current/
-->

<group name="windows,sysmon,">

  <!-- ============================================ -->
  <!-- SYSMON BASE PARENT RULES (Events 1-26)       -->
  <!-- ============================================ -->

  <!-- Rule 61603: Sysmon Event 1 - Process Creation -->
  <rule id="61603" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^1$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 1: Process creation detected</description>
    <options>no_full_log</options>
    <group>sysmon,process_creation,</group>
  </rule>

  <!-- Rule 61604: Sysmon Event 2 - File Creation Time Changed -->
  <rule id="61604" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^2$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 2: File creation time changed</description>
    <options>no_full_log</options>
    <group>sysmon,file_change,</group>
  </rule>

  <!-- Rule 61605: Sysmon Event 3 - Network Connection -->
  <rule id="61605" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^3$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 3: Network connection detected</description>
    <options>no_full_log</options>
    <group>sysmon,network_connection,</group>
  </rule>

  <!-- Rule 61606: Sysmon Event 4 - Sysmon Service State Changed -->
  <rule id="61606" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^4$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 4: Sysmon service state changed</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_status,</group>
  </rule>

  <!-- Rule 61607: Sysmon Event 5 - Process Terminated -->
  <rule id="61607" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^5$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 5: Process terminated</description>
    <options>no_full_log</options>
    <group>sysmon,process_termination,</group>
  </rule>

  <!-- Rule 61608: Sysmon Event 6 - Driver Loaded -->
  <rule id="61608" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^6$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 6: Driver loaded</description>
    <options>no_full_log</options>
    <group>sysmon,driver_load,</group>
    <mitre>
      <id>T1068</id>
    </mitre>
  </rule>

  <!-- Rule 61609: Sysmon Event 7 - Image Loaded -->
  <rule id="61609" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^7$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 7: Image (DLL) loaded</description>
    <options>no_full_log</options>
    <group>sysmon,image_load,</group>
  </rule>

  <!-- Rule 61610: Sysmon Event 8 - CreateRemoteThread -->
  <rule id="61610" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^8$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 8: CreateRemoteThread detected</description>
    <options>no_full_log</options>
    <group>sysmon,create_remote_thread,</group>
    <mitre>
      <id>T1055</id>
    </mitre>
  </rule>

  <!-- Rule 61611: Sysmon Event 9 - RawAccessRead -->
  <rule id="61611" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^9$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 9: RawAccessRead detected</description>
    <options>no_full_log</options>
    <group>sysmon,raw_access_thread,</group>
    <mitre>
      <id>T1003</id>
    </mitre>
  </rule>

  <!-- Rule 61612: Sysmon Event 10 - ProcessAccess -->
  <rule id="61612" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^10$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 10: Process access detected</description>
    <options>no_full_log</options>
    <group>sysmon,process_access,</group>
    <mitre>
      <id>T1003</id>
    </mitre>
  </rule>

  <!-- Rule 61613: Sysmon Event 11 - FileCreate -->
  <rule id="61613" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^11$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 11: File created</description>
    <options>no_full_log</options>
    <group>sysmon,file_event,</group>
  </rule>

  <!-- Rule 61614: Sysmon Event 12 - Registry Object Added/Deleted -->
  <rule id="61614" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^12$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 12: Registry object added or deleted</description>
    <options>no_full_log</options>
    <group>sysmon,registry_event,registry_add,registry_delete,</group>
  </rule>

  <!-- Rule 61615: Sysmon Event 13 - Registry Value Set -->
  <rule id="61615" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^13$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 13: Registry value set</description>
    <options>no_full_log</options>
    <group>sysmon,registry_set,registry_event,</group>
  </rule>

  <!-- Rule 61616: Sysmon Event 14 - Registry Object Renamed -->
  <rule id="61616" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^14$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 14: Registry key or value renamed</description>
    <options>no_full_log</options>
    <group>sysmon,registry_rename,registry_event,</group>
  </rule>

  <!-- Rule 61617: Sysmon Event 15 - FileCreateStreamHash -->
  <rule id="61617" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^15$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 15: File stream created (NTFS ADS)</description>
    <options>no_full_log</options>
    <group>sysmon,create_stream_hash,</group>
    <mitre>
      <id>T1564.004</id>
    </mitre>
  </rule>

  <!-- Rule 61618: Sysmon Event 16 - Sysmon Configuration Change -->
  <rule id="61618" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^16$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 16: Sysmon configuration changed</description>
    <options>no_full_log</options>
    <group>sysmon,sysmon_status,</group>
  </rule>

  <!-- Rule 61619: Sysmon Event 17 - Pipe Created -->
  <rule id="61619" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^17$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 17: Named pipe created</description>
    <options>no_full_log</options>
    <group>sysmon,pipe_created,</group>
    <mitre>
      <id>T1090</id>
    </mitre>
  </rule>

  <!-- Rule 61620: Sysmon Event 18 - Pipe Connected -->
  <rule id="61620" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^18$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 18: Named pipe connected</description>
    <options>no_full_log</options>
    <group>sysmon,pipe_created,</group>
    <mitre>
      <id>T1090</id>
    </mitre>
  </rule>

  <!-- Rule 61621: Sysmon Event 19 - WMI Event Filter Activity -->
  <rule id="61621" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^19$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 19: WMI event filter activity detected</description>
    <options>no_full_log</options>
    <group>sysmon,wmi_event,</group>
    <mitre>
      <id>T1047</id>
    </mitre>
  </rule>

  <!-- Rule 61622: Sysmon Event 20 - WMI Event Consumer Activity -->
  <rule id="61622" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^20$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 20: WMI event consumer activity detected</description>
    <options>no_full_log</options>
    <group>sysmon,wmi_event,</group>
    <mitre>
      <id>T1047</id>
    </mitre>
  </rule>

  <!-- Rule 61623: Sysmon Event 21 - WMI Event Consumer to Filter Binding -->
  <rule id="61623" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^21$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 21: WMI event consumer to filter binding detected</description>
    <options>no_full_log</options>
    <group>sysmon,wmi_event,</group>
    <mitre>
      <id>T1047</id>
    </mitre>
  </rule>

  <!-- Rule 61624: Sysmon Event 22 - DNS Query -->
  <rule id="61624" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^22$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 22: DNS query detected</description>
    <options>no_full_log</options>
    <group>sysmon,dns_query,</group>
    <mitre>
      <id>T1071</id>
    </mitre>
  </rule>

  <!-- Rule 61625: Sysmon Event 23 - File Delete -->
  <rule id="61625" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^23$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 23: File delete detected</description>
    <options>no_full_log</options>
    <group>sysmon,file_delete,</group>
    <mitre>
      <id>T1107</id>
      <id>T1485</id>
    </mitre>
  </rule>

  <!-- Rule 61626: Sysmon Event 24 - Clipboard Change -->
  <rule id="61626" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^24$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 24: Clipboard content changed</description>
    <options>no_full_log</options>
    <group>sysmon,clipboard_capture,</group>
    <mitre>
      <id>T1115</id>
    </mitre>
  </rule>

  <!-- Rule 61627: Sysmon Event 25 - Process Tampering -->
  <rule id="61627" level="7">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^25$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 25: Process image tampering detected</description>
    <options>no_full_log</options>
    <group>sysmon,process_tampering,</group>
    <mitre>
      <id>T1055</id>
    </mitre>
  </rule>

  <!-- Rule 61628: Sysmon Event 26 - File Delete Logged -->
  <rule id="61628" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^26$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 26: File delete operation logged</description>
    <options>no_full_log</options>
    <group>sysmon,file_delete,</group>
    <mitre>
      <id>T1107</id>
      <id>T1485</id>
    </mitre>
  </rule>

  <!-- Rule 61629: Sysmon Event 27 - File Block Executable -->
  <rule id="61629" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^27$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 27: File block executable detected</description>
    <options>no_full_log</options>
    <group>sysmon,file_block_executable,</group>
    <mitre>
      <id>T1036</id>
    </mitre>
  </rule>

  <!-- Rule 61630: Sysmon Event 28 - File Block Shredding -->
  <rule id="61630" level="5">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^28$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 28: File block shredding detected</description>
    <options>no_full_log</options>
    <group>sysmon,file_block_shredding,</group>
    <mitre>
      <id>T1485</id>
    </mitre>
  </rule>

  <!-- Rule 61631: Sysmon Event 29 - File Executable Detected -->
  <rule id="61631" level="3">
    <if_sid>18100</if_sid>
    <field name="win.system.eventID">^29$</field>
    <field name="win.system.channel">^Microsoft-Windows-Sysmon</field>
    <description>Sysmon Event 29: File executable detected</description>
    <options>no_full_log</options>
    <group>sysmon,file_executable_detected,</group>
  </rule>

  <!-- ============================================ -->
  <!-- EXTENDED DETECTION RULES                     -->
  <!-- ============================================ -->

  <!-- Rule 100200: Suspicious Named Pipe Creation -->
  <rule id="100200" level="7">
    <if_sid>61619</if_sid>
    <field name="win.eventdata.pipeName" type="pcre2">\\(msagent_|MSSE-|postex_|status_|MsFteWds)</field>
    <description>Sysmon: Suspicious named pipe created (possible C2 activity)</description>
    <mitre>
      <id>T1090</id>
      <id>T1071</id>
    </mitre>
    <group>sysmon,pipe_created,malware,</group>
  </rule>

  <!-- Rule 100201: Suspicious Named Pipe Connection -->
  <rule id="100201" level="7">
    <if_sid>61620</if_sid>
    <field name="win.eventdata.pipeName" type="pcre2">\\(msagent_|MSSE-|postex_|status_|MsFteWds)</field>
    <description>Sysmon: Suspicious named pipe connection (possible C2 activity)</description>
    <mitre>
      <id>T1090</id>
      <id>T1071</id>
    </mitre>
    <group>sysmon,pipe_created,malware,</group>
  </rule>

  <!-- Rule 100202: DNS Query to Suspicious TLD -->
  <rule id="100202" level="7">
    <if_sid>61624</if_sid>
    <field name="win.eventdata.queryName" type="pcre2">\\.(tk|ml|ga|cf|gq)$</field>
    <description>Sysmon: DNS query to suspicious free TLD</description>
    <mitre>
      <id>T1071</id>
    </mitre>
    <group>sysmon,dns_query,suspicious,</group>
  </rule>

  <!-- Rule 100203: WMI Event Filter Created -->
  <rule id="100203" level="10">
    <if_sid>61621</if_sid>
    <field name="win.eventdata.eventType">^WmiEventFilter$</field>
    <description>Sysmon: WMI event filter created (potential persistence mechanism)</description>
    <mitre>
      <id>T1047</id>
      <id>T1546.003</id>
    </mitre>
    <group>sysmon,wmi_event,persistence,</group>
  </rule>

  <!-- Rule 100204: WMI Event Consumer Created -->
  <rule id="100204" level="10">
    <if_sid>61622</if_sid>
    <field name="win.eventdata.eventType">^WmiEventConsumer$</field>
    <description>Sysmon: WMI event consumer created (potential persistence mechanism)</description>
    <mitre>
      <id>T1047</id>
      <id>T1546.003</id>
    </mitre>
    <group>sysmon,wmi_event,persistence,</group>
  </rule>

  <!-- Rule 100205: WMI FilterToConsumer Binding -->
  <rule id="100205" level="10">
    <if_sid>61623</if_sid>
    <field name="win.eventdata.eventType">^WmiFilterToConsumerBinding$</field>
    <description>Sysmon: WMI filter to consumer binding created (persistence activated)</description>
    <mitre>
      <id>T1047</id>
      <id>T1546.003</id>
    </mitre>
    <group>sysmon,wmi_event,persistence,</group>
  </rule>

  <!-- Rule 100206: Critical File Deletion -->
  <rule id="100206" level="10">
    <if_sid>61625</if_sid>
    <field name="win.eventdata.targetFilename" type="pcre2">(?i)(\\Windows\\System32\\|\\Program Files\\|\.evtx$)</field>
    <description>Sysmon: Critical system file or event log deleted</description>
    <mitre>
      <id>T1070.001</id>
      <id>T1485</id>
    </mitre>
    <group>sysmon,file_delete,defense_evasion,</group>
  </rule>

  <!-- Rule 100207: Clipboard Data Capture -->
  <rule id="100207" level="5">
    <if_sid>61626</if_sid>
    <field name="win.eventdata.archived">^true$</field>
    <description>Sysmon: Clipboard data captured and archived</description>
    <mitre>
      <id>T1115</id>
    </mitre>
    <group>sysmon,clipboard_capture,collection,</group>
  </rule>

  <!-- Rule 100208: Process Tampering Detected -->
  <rule id="100208" level="12">
    <if_sid>61627</if_sid>
    <description>Sysmon: Process image tampering detected (potential code injection)</description>
    <mitre>
      <id>T1055</id>
      <id>T1027</id>
    </mitre>
    <group>sysmon,process_tampering,defense_evasion,</group>
  </rule>

  <!-- Rule 100209: Security Event Log Cleared via Sysmon -->
  <rule id="100209" level="15">
    <if_sid>61625</if_sid>
    <field name="win.eventdata.targetFilename" type="pcre2">(?i)\\Windows\\System32\\winevt\\Logs\\Security\.evtx</field>
    <description>Sysmon: Security event log file deleted (audit trail destruction)</description>
    <mitre>
      <id>T1070.001</id>
    </mitre>
    <group>sysmon,file_delete,defense_evasion,pci_dss_10.6.1,pci_dss_10.2.7,gpg13_4.14,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.6,nist_800_53_AU.14,</group>
  </rule>

  <!-- Rule 100210: Pass-the-Hash Detection via Process Access -->
  <rule id="100210" level="12">
    <if_sid>61612</if_sid>
    <field name="win.eventdata.targetImage" type="pcre2">(?i)\\lsass\.exe$</field>
    <field name="win.eventdata.grantedAccess" type="pcre2">^(0x1010|0x1410|0x1438|0x143a|0x1fffff)</field>
    <description>Sysmon: Suspicious LSASS process access (possible credential dumping)</description>
    <mitre>
      <id>T1003.001</id>
    </mitre>
    <group>sysmon,process_access,credential_access,</group>
  </rule>

  <!-- Rule 100211: Unsigned Driver Loaded -->
  <rule id="100211" level="10">
    <if_sid>61608</if_sid>
    <field name="win.eventdata.signed">^false$</field>
    <description>Sysmon: Unsigned driver loaded (potential rootkit or malware)</description>
    <mitre>
      <id>T1068</id>
      <id>T1014</id>
    </mitre>
    <group>sysmon,driver_load,privilege_escalation,</group>
  </rule>

</group>
